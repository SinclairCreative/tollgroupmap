<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Toll Group Communities Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.11.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.11.0/mapbox-gl.js"></script>
  <style>
    /* =========================
       GENERAL LAYOUT & STYLES
    ========================== */
    body {
      margin: 0;
      padding: 0;
      background: #fff;
      color: #333;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      width: 100vw;
      box-sizing: border-box;
    }
    #main-layout {
      display: flex;
      flex-direction: row;
      width: 100vw;
      height: 100vh;
      background: #fff;
      box-sizing: border-box;
    }
    #map-container {
      flex: 2 1 0;
      min-width: 0;
      height: 100vh;
      max-width: 1100px;
      border-radius: 0 14px 14px 0;
      overflow: hidden;
      box-shadow: 0 2px 16px rgba(0,0,0,0.13);
      background: #fff;
      position: relative;
      display: flex;
      flex-direction: column;
    }
    #map { width: 100%; height: 100%; }

    /* =========================
       BUTTONS & SEARCH BAR
    ========================== */
    #recenter-btn, #geolocate-btn {
      position: absolute;
      top: 18px;
      z-index: 10;
      background: #fff;
      border: 1.5px solid #1076ad;
      border-radius: 50px;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      transition: background 0.2s, color 0.2s;
      padding: 0;
    }
    #recenter-btn { left: 18px; color: #1076ad; font-size: 1.3em; font-weight: bold; }
    #recenter-btn:hover { background: #1076ad; color: #fff; }
    #geolocate-btn { left: 74px; }
    #geolocate-btn svg { width: 28px; height: 28px; display: block; }
    #geolocate-btn:hover { background: #1076ad; }
    #geolocate-btn:hover svg path { stroke: #fff; }

    #search-bar-wrap {
      position: absolute;
      top: 18px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      width: 320px;
      max-width: 80vw;
      background: rgba(255,255,255,0.95);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      padding: 6px 16px;
      display: flex;
      align-items: center;
    }
    #search-bar {
      width: 100%;
      border: none;
      outline: none;
      font-size: 1.08em;
      background: transparent;
      color: #222;
      padding: 8px 0;
      font-family: inherit;
    }
    #search-bar::placeholder { color: #aaa; font-weight: 400; letter-spacing: 0.01em; }
    #autocomplete-list {
      position: absolute;
      top: 48px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 20;
      width: 320px;
      max-width: 80vw;
      background: #fff;
      border-radius: 0 0 12px 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.10);
      border: 1px solid #e0e0e0;
      display: none;
      flex-direction: column;
      font-size: 1em;
    }
    .autocomplete-item {
      padding: 10px 16px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .autocomplete-item:hover, .autocomplete-item.active { background: #eaf6fb; }

    /* =========================
       DIRECTORY SIDEBAR
    ========================== */
    #directory {
      flex: 1 1 340px;
      max-width: 400px;
      min-width: 280px;
      background: transparent;
      padding: 0;
      overflow-y: auto;
      border-left: none;
      box-shadow: none;
      display: flex;
      flex-direction: column;
      height: 100vh;
      max-height: 100vh;
      scrollbar-width: thin;
      scrollbar-color: #ccc #fff;
      margin-left: 10px;
      margin-right: 10px;
    }
    #directory::-webkit-scrollbar-thumb { background: #ccc; border-radius: 8px; }
    #directory::-webkit-scrollbar-track { background: #f8f9fa; border-radius: 8px; }
    #filters-sort {
      display: flex;
      align-items: center;
      gap: 18px;
      padding: 18px 24px 0 24px;
      background: #ffffff;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    #sort-select {
      border: none;
      background: #e9ecef;
      border-radius: 8px;
      padding: 7px 16px;
      font-size: 1em;
      color: #222;
      font-family: inherit;
      box-shadow: 0 1px 3px rgba(0,0,0,0.03);
      transition: background 0.2s;
    }
    #sort-select:focus { outline: 2px solid #1076ad; background: #fff; }
    #directory-list {
      padding: 18px 0 24px 0;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    /* =========================
       DIRECTORY ITEM STYLES
    ========================== */
    .directory-item {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 0;
      padding-left: 0;
      padding-right: 0;
      border-radius: 18px;
      background: #fff;
      box-shadow: 0 2px 16px rgba(0,0,0,0.06);
      cursor: pointer;
      border: 2px solid transparent;
      transition: border 0.2s, box-shadow 0.2s, background 0.2s;
      min-height: 120px;
      overflow: hidden;
      margin: 0 6px;
    }
    .directory-item.active {
      border: 2px solid #1076ad;
      box-shadow: 0 4px 24px rgba(16,118,173,0.10);
      background: #eaf6fb;
    }
    .dir-img-wrap {
      width: calc(100% + 10px);
      margin: 0 -5px;
      height: 180px;
      border-radius: 18px 18px 0 0;
      overflow: hidden;
      background: #eee;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .dir-img-wrap img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.2s;
      border-radius: 18px 18px 0 0;
      display: block;
    }
    .directory-item:hover .dir-img-wrap img { transform: scale(1.04); }
    .no-img {
      width: 360px;
      height: 180px;
      background: #eee;
      border-radius: 18px 18px 0 0;
      display: block;
    }
    .dir-info {
      flex: 1 1 0;
      width: 100%;
      padding: 18px 10px 14px 10px;
      display: flex;
      flex-direction: column;
      gap: 7px;
    }
    .dir-title { font-size: 1.18rem; font-weight: 600; margin-bottom: 2px; color: #222; letter-spacing: -0.01em; margin-left: 10px !important; }
    .dir-address { color: #444; font-size: 1.01em; margin-bottom: 2px; margin-left: 10px !important; margin-top: 2px !important; }
    .dir-details { color: #555; font-size: 1em; margin: 8px 0 0 0; padding: 8px 0 0 0; border-top: 1px solid #e0e0e0; font-style: italic; line-height: 1.5; margin-left: 10px !important; }
    .dir-links { margin-top: 12px; display: flex; gap: 16px; justify-content: center; margin-left: 0 !important; }
    .dir-link-btn {
      display: inline-block;
      padding: 8px 18px;
      border-radius: 8px;
      background: #f2f7fa;
      color: #1076ad;
      font-weight: 600;
      font-size: 1em;
      border: 1.5px solid #1076ad;
      text-decoration: none;
      transition: background 0.18s, color 0.18s, border 0.18s;
      box-shadow: 0 2px 8px rgba(16,118,173,0.07);
      text-align: center;
    }
    .dir-link-btn:hover { background: #1076ad; color: #fff; border: 1.5px solid #1076ad; }

    /* =========================
       MAP MARKERS & CLUSTERS
    ========================== */
    .custom-marker { background: none !important; }
    .custom-cluster {
      background: #fff;
      border: 2.5px solid #1076ad;
      color: #1076ad;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.85em;
      box-shadow: 0 2px 8px rgba(16,118,173,0.09);
      transition: background 0.2s, color 0.2s;
      cursor: pointer;
      user-select: none;
    }
    .custom-cluster:hover { background: #1076ad; color: #fff; }

    /* =========================
       RESPONSIVE
    ========================== */
    @media (max-width: 900px) {
      #main-layout { flex-direction: column; }
      #directory {
        order: 2;
        border-top: none;
        border-bottom: 1px solid #e0e0e0;
        margin-left: 0;
        max-width: 100vw;
        min-width: 0;
        height: auto;
        max-height: none;
        background: transparent;
      }
      #directory-list { display: flex; flex-direction: column; gap: 18px; }
      #selected-listing-mobile { order: 0; width: 100vw; max-width: 100vw; margin: 0; z-index: 3; }
      #map-container { order: 1; border-radius: 0; max-width: 100vw; height: 340px; }
    }
    @media (max-width: 600px) {
      #map-container { height: 220px; }
    }
  </style>
</head>
<body>
  <div id="main-layout">
    <div id="map-container">
      <div id="map"></div>
      <button id="recenter-btn" title="Recenter Map" aria-label="Recenter Map">⟳</button>
      <button id="geolocate-btn" title="Find My Location" aria-label="Find My Location">
        <svg viewBox="0 0 28 28" fill="none">
          <circle cx="14" cy="14" r="10" stroke="#1076ad" stroke-width="2"/>
          <circle cx="14" cy="14" r="4" fill="#fff" stroke="#1076ad" stroke-width="2"/>
          <path d="M14 2v4M14 22v4M2 14h4M22 14h4" stroke="#1076ad" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
      <div id="search-bar-wrap">
        <input id="search-bar" type="text" placeholder="Search for a community..." autocomplete="on" />
      </div>
      <div id="autocomplete-list"></div>
    </div>
    <aside id="directory">
      <div id="filters-sort">
        <select id="sort-select">
          <option value="az">Sort: A–Z</option>
          <option value="za">Sort: Z–A</option>
          <option value="distance">Distance to Me</option>
        </select>
      </div>
      <div id="directory-list"></div>
    </aside>
  </div>
  <script src="https://unpkg.com/supercluster@7.1.5/dist/supercluster.min.js"></script>
  <script>
    // =========================
    // CONFIG & CONSTANTS
    // =========================
    mapboxgl.accessToken = 'pk.eyJ1IjoianVzdGluc2luY2xhaXJjcmVhdGl2ZSIsImEiOiJjbTl2dmJ2Z20wb3M4MnFtdzVqZ3l1YTdtIn0.yRr3osd2oFqcKbjg_3O1Hg';
    const mapStyle = 'mapbox://styles/justinsinclaircreative/cma43snlr002t01sih71s9nng';
    const sheetId = '1zNOmpkUNr-dwKaWR8iuvPsNTc9TKYbL3UFL90ci2Mxc';
    const gid = '0';
    const markerPNGs = {
      normal: 'https://sinclaircreative.github.io/tollgroupmap/tollgroupicon.png',
      hover:  'https://sinclaircreative.github.io/tollgroupmap/tollgroupiconhover.png',
      active: 'https://sinclaircreative.github.io/tollgroupmap/tollgroupiconclick.png'
    };

    // =========================
    // MAP INITIALIZATION
    // =========================
    const initialCenter = [-121.052,47.739];
    const initialZoom = 6.75;
    const map = new mapboxgl.Map({
      container: 'map',
      style: mapStyle,
      center: initialCenter,
      zoom: initialZoom
    });
    map.addControl(new mapboxgl.NavigationControl(), 'top-right');

    // =========================
    // BUTTONS & GEOLOCATION
    // =========================
    document.getElementById('recenter-btn').onclick = () => {
      map.flyTo({ center: initialCenter, zoom: initialZoom });
    };

    let userLocation = null;
    document.getElementById('geolocate-btn').onclick = () => {
      if (!navigator.geolocation) {
        alert('Geolocation is not supported by your browser.');
        return;
      }
      navigator.geolocation.getCurrentPosition(
        pos => {
          userLocation = [pos.coords.longitude, pos.coords.latitude];
          map.flyTo({ center: userLocation, zoom: 11 });
          if (!window._userMarker) {
            window._userMarker = new mapboxgl.Marker({ color: "#1076ad" })
              .setLngLat(userLocation)
              .addTo(map);
          } else {
            window._userMarker.setLngLat(userLocation);
          }
          if (document.getElementById('sort-select').value === 'distance') {
            document.getElementById('sort-select').dispatchEvent(new Event('change'));
          }
        },
        err => alert('Unable to retrieve your location.')
      );
    };

    // =========================
    // DATA FETCH & GEOCODE
    // =========================
    function fetchSheetData() {
      return new Promise((resolve, reject) => {
        window.google = { visualization: { Query: { setResponse: res => {
          const rows = res.table.rows;
          const data = rows.slice(1).map(r => {
            let imgCell = r.c[5]?.v || '';
            if (typeof imgCell === 'object' && imgCell !== null && imgCell.u) imgCell = imgCell.u;
            if (typeof imgCell === 'string' && imgCell.startsWith('=IMAGE(')) {
              const match = imgCell.match(/=IMAGE\("([^"]+)"/);
              if (match) imgCell = match[1];
            }
            return {
              title:   r.c[0]?.v || '',
              address: r.c[1]?.v || '',
              details: r.c[2]?.v || '',
              webpage: r.c[3]?.v || '',
              gmap:    r.c[4]?.v || '',
              image:   imgCell
            };
          }).filter(r => r.title && r.address);
          resolve(data);
        }}}};
        const s = document.createElement('script');
        s.src = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?gid=${gid}&tqx=out:json-in-script`;
        s.onerror = reject;
        document.head.appendChild(s);
      });
    }

    async function geocodeListings(listings) {
      for (const l of listings) {
        const key = `geo_${l.address}`;
        const cached = localStorage.getItem(key);
        if (cached) {
          l.coords = JSON.parse(cached);
        } else {
          try {
            const resp = await fetch(
              `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(l.address)}.json?access_token=${mapboxgl.accessToken}`
            );
            const js = await resp.json();
            l.coords = js.features[0]?.geometry.coordinates || null;
            if (l.coords) localStorage.setItem(key, JSON.stringify(l.coords));
          } catch {
            l.coords = null;
          }
        }
      }
      return listings.filter(l => Array.isArray(l.coords));
    }

    // =========================
    // MARKER IMAGE HELPER
    // =========================
    function getMarkerImg(state = 'normal') {
      const url = markerPNGs[state] || markerPNGs.normal;
      return `<img src="${url}" alt="Map marker" style="width:48px;height:48px;display:block;object-fit:contain;">`;
    }

    // =========================
    // DISTANCE CALCULATION
    // =========================
    function getDistanceMeters(coord1, coord2) {
      const toRad = d => d * Math.PI / 180;
      const [lon1, lat1] = coord1;
      const [lon2, lat2] = coord2;
      const R = 6371000;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // =========================
    // MAIN DIRECTORY & MAP LOGIC
    // =========================
    function addMarkersAndDirectory(listings) {
      let filteredListings = listings.slice();
      let sortOrder = 'az';
      let searchTerm = '';
      let activeIdx = null;
      const markers = [];
      let clusterIndex = null;
      let clusterMarkers = [];
      const markerElements = [];
      const directory = document.getElementById('directory-list');
      const searchBar = document.getElementById('search-bar');
      const sortSelect = document.getElementById('sort-select');
      const autocompleteList = document.getElementById('autocomplete-list');

      // --- CLUSTERING SETUP ---
      const geojsonFeatures = listings.map((l, i) => ({
        type: "Feature",
        geometry: { type: "Point", coordinates: l.coords },
        properties: { index: i }
      }));
      clusterIndex = new Supercluster({
        radius: 60,
        maxZoom: 16
      }).load(geojsonFeatures);

      function clearClusterMarkers() {
        clusterMarkers.forEach(m => m.remove());
        clusterMarkers = [];
      }

      // --- MARKERS ---
      listings.forEach((l, i) => {
        const el = document.createElement('div');
        el.className = 'custom-marker';
        el.style.width = '48px';
        el.style.height = '48px';
        el.style.background = 'none';
        el.style.border = 'none';
        el.style.cursor = 'pointer';
        el.style.display = 'flex';
        el.style.alignItems = 'center';
        el.style.justifyContent = 'center';
        el.setAttribute('tabindex', '0');
        el.setAttribute('aria-label', `${l.title}, ${l.address}`);

        const img = document.createElement('img');
        img.src = markerPNGs.normal;
        img.alt = "Map marker";
        img.style.width = "48px";
        img.style.height = "48px";
        img.style.display = "block";
        img.style.objectFit = "contain";
        el.appendChild(img);

        // --- HOVER LOGIC ---
        el.addEventListener('mouseenter', () => { img.src = markerPNGs.hover; });
        el.addEventListener('mouseleave', () => { img.src = markerPNGs[activeIdx === i ? 'active' : 'normal']; });

        // --- CLICK LOGIC ---
        el.addEventListener('click', e => {
          e.stopPropagation();
          setActiveMarker(i);
          const targetZoom = 15;
          const currentZoom = map.getZoom();
          const currentCenter = map.getCenter();
          const [lng, lat] = l.coords;
          const isCentered = Math.abs(currentCenter.lng - lng) < 0.0001 && Math.abs(currentCenter.lat - lat) < 0.0001;
          if (currentZoom < targetZoom - 0.1 || !isCentered) {
            zoomToPropertyAndNearby(i, listings);
          }
          activateListing(i, listings, filteredListings, markers, renderDirectory);
        });
        el.addEventListener('keydown', e => {
          if (e.key === 'Enter' || e.key === ' ') {
            setActiveMarker(i);
            const targetZoom = 15;
            const currentZoom = map.getZoom();
            const currentCenter = map.getCenter();
            const [lng, lat] = l.coords;
            const isCentered = Math.abs(currentCenter.lng - lng) < 0.0001 && Math.abs(currentCenter.lat - lat) < 0.0001;
            if (currentZoom < targetZoom - 0.1 || !isCentered) {
              zoomToPropertyAndNearby(i, listings);
            }
            activateListing(i, listings, filteredListings, markers, renderDirectory);
          }
        });

        const marker = new mapboxgl.Marker(el, { clickTolerance: 8 })
          .setLngLat(l.coords)
          .addTo(map);

        markers.push(marker);
        markerElements.push({ marker, el, i });
      });

      // --- CLUSTER RENDERING ---
      function renderClusters() {
        clearClusterMarkers();
        markerElements.forEach(({ marker }) => marker.getElement().style.display = "none");

        const bounds = map.getBounds();
        const zoom = Math.round(map.getZoom());
        const clusters = clusterIndex.getClusters([
          bounds.getWest(), bounds.getSouth(),
          bounds.getEast(), bounds.getNorth()
        ], zoom);

        clusters.forEach(cluster => {
          const [lng, lat] = cluster.geometry.coordinates;
          if (cluster.properties.cluster) {
            const count = cluster.properties.point_count;
            const size = 48 * Math.pow(1.05, count - 1);
            const el = document.createElement('div');
            el.className = 'custom-cluster';
            el.dataset.clusterId = cluster.id;
            el.textContent = count;
            el.style.width = `${size}px`;
            el.style.height = `${size}px`;
            el.style.fontSize = `${size * 0.385}px`;
            el.onclick = () => {
              const expansionZoom = Math.min(clusterIndex.getClusterExpansionZoom(cluster.id), 16);
              map.easeTo({
                center: [lng, lat],
                zoom: expansionZoom,
                duration: 800,
                essential: true
              });
            };
            const marker = new mapboxgl.Marker(el)
              .setLngLat([lng, lat])
              .addTo(map);
            clusterMarkers.push(marker);
          } else {
            const idx = cluster.properties.index;
            if (typeof idx === "number" && markerElements[idx]) {
              markerElements[idx].marker.getElement().style.display = "";
            }
          }
        });
      }
      map.on('moveend', renderClusters);
      map.on('zoomend', renderClusters);

      // --- AUTOCOMPLETE ---
      function showAutocomplete(matches) {
        autocompleteList.innerHTML = '';
        if (!matches.length) {
          autocompleteList.style.display = 'none';
          return;
        }
        matches.forEach((l, idx) => {
          let cityState = l.address;
          const match = l.address.match(/([^,]+,\s*[A-Z]{2})/);
          if (match) cityState = match[1].trim();
          const item = document.createElement('div');
          item.className = 'autocomplete-item';
          item.textContent = l.title + ' – ' + cityState;
          item.onclick = () => {
            searchBar.value = l.title;
            autocompleteList.style.display = 'none';
            const i = listings.indexOf(l);
            if (i !== -1) {
              activeIdx = i;
              activateListing(i, listings, filteredListings, markers, renderDirectory);
            }
          };
          autocompleteList.appendChild(item);
        });
        autocompleteList.style.display = 'flex';
      }
      searchBar.addEventListener('input', e => {
        searchTerm = e.target.value.trim().toLowerCase();
        if (searchTerm.length > 0) {
          const matches = listings.filter(l =>
            l.title.toLowerCase().includes(searchTerm) ||
            l.address.toLowerCase().includes(searchTerm)
          ).slice(0, 8);
          showAutocomplete(matches);
        } else {
          autocompleteList.style.display = 'none';
        }
        applyFilters();
      });
      searchBar.addEventListener('focus', () => {
        const val = searchBar.value.trim().toLowerCase();
        if (val.length > 0) {
          const matches = listings.filter(l =>
            l.title.toLowerCase().includes(val) ||
            l.address.toLowerCase().includes(val)
          ).slice(0, 8);
          showAutocomplete(matches);
        }
      });
      document.addEventListener('click', e => {
        if (!autocompleteList.contains(e.target) && e.target !== searchBar) {
          autocompleteList.style.display = 'none';
        }
      });

      // --- DIRECTORY RENDERING ---
      function renderDirectory(activeIndex = null) {
        directory.innerHTML = '';
        let ordered = filteredListings.slice();
        ordered.sort((a, b) => {
          if (sortOrder === 'az') return a.title.localeCompare(b.title);
          if (sortOrder === 'za') return b.title.localeCompare(a.title);
          if (sortOrder === 'distance' && userLocation) {
            const da = getDistanceMeters(a.coords, userLocation);
            const db = getDistanceMeters(b.coords, userLocation);
            return da - db;
          }
          return 0;
        });
        if (activeIndex !== null) {
          const idx = ordered.findIndex(l => l === filteredListings[activeIndex]);
          if (idx > -1) {
            const [active] = ordered.splice(idx, 1);
            ordered.unshift(active);
          }
        }
        ordered.forEach((l, idx) => {
          const i = listings.indexOf(l);
          let cityState = l.address;
          const match = l.address.match(/([^,]+,\s*[A-Z]{2})/);
          if (match) cityState = match[1].trim();
          const detailsId = `details-${i}`;
          const div = document.createElement('div');
          div.className = 'directory-item' + (i === activeIdx ? ' active' : '');
          div.tabIndex = 0;
          div.setAttribute('aria-label', l.title + ', ' + cityState);
          div.innerHTML = `
            <div class="dir-img-wrap">
              ${l.image ? `<img src="${l.image}" alt="${l.title}">` : `<div class="no-img"></div>`}
            </div>
            <div class="dir-info">
              <div style="display: flex; align-items: flex-start; gap: 0; flex-wrap: wrap; justify-content: space-between;">
                <div style="flex:1 1 0; min-width:0;">
                  <div class="dir-title">${l.title}</div>
                  <div class="dir-address">${cityState}</div>
                </div>
                <div style="display:flex; align-items:center; justify-content:center; flex:0 0 180px;">
                  <button class="dir-details-btn"
                    data-details-id="${detailsId}"
                    style="border:none; background:#d4ecf7; color:#1076ad; border-radius:6px; padding:6px 18px; font-weight:600; cursor:pointer; font-size:1em; margin:0 auto;">
                    Details
                  </button>
                </div>
              </div>
              <div id="${detailsId}" class="dir-details-section" style="display:none; margin-top:10px;">
                ${l.details ? `<div class="dir-details">${l.details.replace(/\r?\n/g, '<br>')}</div>` : ''}
                <div class="dir-links">
                  ${l.webpage ? `<a class="dir-link-btn" href="${l.webpage}" target="_blank">Property Page</a>` : ''}
                  ${l.gmap ? `<a class="dir-link-btn" href="${l.gmap}" target="_blank">Google Maps</a>` : ''}
                </div>
                ${sortOrder === 'distance' && userLocation ? `<div class="dir-distance">${Math.round(getDistanceMeters(l.coords, userLocation)/1609)} mi away</div>` : ''}
              </div>
            </div>
          `;
          setTimeout(() => {
            const btn = div.querySelector('.dir-details-btn');
            const detailsSection = div.querySelector(`#${detailsId}`);
            if (btn && detailsSection) {
              btn.onclick = (e) => {
                e.stopPropagation();
                const isOpen = detailsSection.style.display === 'block';
                detailsSection.style.display = isOpen ? 'none' : 'block';
                btn.textContent = isOpen ? 'Details' : 'Hide Details';
              };
            }
          }, 0);
          div.addEventListener('click', () => {
            setActiveMarker(i);
            const clusterMarker = findClusterMarkerForListing(i);
            if (clusterMarker) {
              clusterMarker.getElement().dispatchEvent(
                new MouseEvent('click', { bubbles: true })
              );
              map.once('moveend', () => {
                markers[i].getElement().dispatchEvent(
                  new MouseEvent('click', { bubbles: true })
                );
              });
            } else {
              markers[i].getElement().dispatchEvent(
                new MouseEvent('click', { bubbles: true })
              );
            }
          });
          directory.appendChild(div);
        });
      }

      // --- MARKER STATE HELPERS ---
      function setActiveMarker(idx) {
        activeIdx = idx;
        markers.forEach((m, mi) => {
          const img = m.getElement().querySelector('img');
          if (img) img.src = markerPNGs[mi === idx ? 'active' : 'normal'];
        });
      }
      function activateListing(i, listings, filteredListings, markers, renderDirectory) {
        const filteredIndex = filteredListings.indexOf(listings[i]);
        renderDirectory(filteredIndex);
        setActiveMarker(i);
        setTimeout(() => {
          const activeDiv = document.querySelector('.directory-item.active');
          if (activeDiv) activeDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
      }

      // --- CLUSTER FINDER ---
      function findClusterMarkerForListing(listingIdx) {
        return clusterMarkers.find(cm => {
          const id = cm.getElement().dataset.clusterId;
          if (!id) return false;
          const leaves = clusterIndex.getLeaves(Number(id), Infinity);
          return leaves.some(leaf => leaf.properties.index === listingIdx);
        });
      }

      // --- FILTERS & SORT ---
      function applyFilters() {
        filteredListings = listings.filter(l =>
          (!searchTerm ||
            l.title.toLowerCase().includes(searchTerm) ||
            l.address.toLowerCase().includes(searchTerm) ||
            (l.webpage && l.webpage.toLowerCase().includes(searchTerm)) ||
            (l.gmap && l.gmap.toLowerCase().includes(searchTerm))
          )
        );
        renderDirectory(null);
      }
      sortSelect.addEventListener('change', e => {
        sortOrder = e.target.value;
        if (sortOrder === 'distance' && !userLocation) {
          document.getElementById('geolocate-btn').click();
        } else {
          renderDirectory(null);
        }
      });

      // --- INITIAL RENDER ---
      renderDirectory();
      renderClusters();
      map.on('moveend', renderClusters);
      map.on('zoomend', renderClusters);

      // --- ZOOM TO PROPERTY & NEARBY ---
      function zoomToPropertyAndNearby(idx, listings) {
        const thisCoords = listings[idx].coords;
        let minDist = Infinity, nearestCoords = null;
        listings.forEach((l, i) => {
          if (i !== idx && Array.isArray(l.coords)) {
            const d = getDistanceMeters(thisCoords, l.coords);
            if (d < minDist) {
              minDist = d;
              nearestCoords = l.coords;
            }
          }
        });
        if (nearestCoords) {
          const bounds = new mapboxgl.LngLatBounds(thisCoords, thisCoords);
          bounds.extend(nearestCoords);
          map.fitBounds(bounds, { padding: 120, maxZoom: 15, duration: 500 });
          map.once('moveend', () => {
            const closerZoom = Math.min(map.getZoom() * 1, 16);
            map.easeTo({ center: thisCoords, zoom: closerZoom, duration: 400 });
          });
        } else {
          map.flyTo({ center: thisCoords, zoom: Math.min(15 * 1.2, 16), duration: 700 });
        }
      }
    }

    // =========================
    // MAIN ENTRYPOINT
    // =========================
    (async function() {
      try {
        const listings = await fetchSheetData();
        const geocoded = await geocodeListings(listings);
        addMarkersAndDirectory(geocoded);
      } catch (e) {
        alert('Failed to load listings.');
        console.error(e);
      }
    })();
  </script>
</body>
</html>
